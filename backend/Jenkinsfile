pipeline {
  agent any

  environment {
    APP_DIR = "/home/ubuntu/ares2-app/backend"
    VENV    = "/home/ubuntu/ares2-app/backend/venv"
  }

  options { timestamps() }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Sync Backend Code') {
      steps {
        sh """
          rsync -a --delete ./backend/ ${APP_DIR}/
        """
      }
    }

    stage('Install Python Deps') {
      steps {
        sh """
          python3 -m venv ${VENV} || true
          . ${VENV}/bin/activate
          pip install --upgrade pip
          pip install -r ${APP_DIR}/requirements.txt
        """
      }
    }

    stage('Restart Flask') {
      steps {
        sh '''
          cd /home/ubuntu/ares2-app/backend
          
          source venv/bin/activate
          pm2 delete flask-app || true
          pm2 start "python3 app.py" --name flask-app
          pm2 save
        '''
      }
    }
  }

  post {
    success { echo 'Flask backend deployed' }
    failure { echo 'Flask backend failed' }
  }
}
